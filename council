#!/bin/bash

# AI Council - Interactive Multi-Agent System
# Usage: ./council [install]

# Handle installation
if [ "$1" = "install" ]; then
    echo "üèõÔ∏è AI Council Installation"
    echo "=========================="
    
    # Get the absolute path to this script
    SCRIPT_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/$(basename "${BASH_SOURCE[0]}")"
    
    # Make sure script is executable
    chmod +x "$SCRIPT_PATH"
    
    # Create local bin directory and symlink
    mkdir -p ~/.local/bin
    echo "üì¶ Creating global 'council' command..."
    ln -sf "$SCRIPT_PATH" ~/.local/bin/council
    
    # Check PATH
    if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
        echo "‚ö†Ô∏è  Add ~/.local/bin to PATH in your shell profile:"
        echo "   export PATH=\"\$HOME/.local/bin:\$PATH\""
    fi
    
    # Check API key
    if [ -z "$ANTHROPIC_API_KEY" ]; then
        echo "üîë Set your API key:"
        echo "   export ANTHROPIC_API_KEY='your-key-here'"
    fi
    
    echo "‚úÖ Installation complete! Run 'council' from anywhere."
    exit 0
fi

# Normal execution: Auto-detect project directory (resolve symlinks)
SCRIPT_PATH="${BASH_SOURCE[0]}"
# Resolve symlinks to find the actual script location
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    # If readlink gave us a relative path, make it absolute
    [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
PROJECT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
VENV_DIR="$PROJECT_DIR/.venv" 
SRC_DIR="$PROJECT_DIR/src"

# Alternative: Use environment variable if set
if [ -n "$AICOUNCIL_HOME" ]; then
    PROJECT_DIR="$AICOUNCIL_HOME"
    VENV_DIR="$PROJECT_DIR/.venv"
    SRC_DIR="$PROJECT_DIR/src"
fi

# Check if virtual environment exists
if [ ! -d "$VENV_DIR" ]; then
    echo "Error: Virtual environment not found at $VENV_DIR"
    echo "Please run: python3 -m venv .venv && source .venv/bin/activate && pip install -r requirements.txt"
    exit 1
fi

# Check if ANTHROPIC_API_KEY is set
if [ -z "$ANTHROPIC_API_KEY" ]; then
    echo "Error: ANTHROPIC_API_KEY environment variable not set"
    echo "Export your key: export ANTHROPIC_API_KEY='your-key-here'"
    echo "Or add it to your ~/.bashrc or ~/.zshrc for permanent setup"
    exit 1
fi

# Activate virtual environment and run the council
echo "üèõÔ∏è Starting AI Council..."
source "$VENV_DIR/bin/activate"
cd "$SRC_DIR"
python run.py